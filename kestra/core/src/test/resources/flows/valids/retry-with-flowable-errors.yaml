id: retry-with-flowable-errors
namespace: io.kestra.tests

tasks:
  - id: set_kv
    type: io.kestra.plugin.core.kv.Set
    key: "retry_counter_1"
    value: "1"
    kvType: NUMBER
    overwrite: true

  - id: retry_block
    type: io.kestra.plugin.core.flow.AllowFailure
    tasks:
      - id: run_script
        type: io.kestra.plugin.core.log.Log
        message: "{{kv(namespace=flow.namespace, key='retry_counter_1') < 2 ? ko : 'It works'}}"
    errors:
      - id: incr_counter
        type: io.kestra.plugin.core.kv.Set
        key: retry_counter_1
        value: "{{ kv(namespace=flow.namespace, key='retry_counter_1') + 1 }}"
        overwrite: true
    retry:
      type: constant
      behavior: RETRY_FAILED_TASK
      maxAttempts: 3
      interval: PT0.5S
      warningOnRetry: true